@page "/history"
@using SecurePasswordGenerator.Domain.Interfaces
@using SecurePasswordGenerator.Domain.Models
@using Microsoft.JSInterop
@inject IPasswordHistoryService HistoryService
@inject IClipboardService ClipboardService
@inject IJSRuntime JSRuntime

<PageTitle>≈ûifre Ge√ßmi≈üi - Secure Password Generator</PageTitle>

<div class="main-container">
    <div class="glass-card" style="max-width: 1400px; margin: 0 auto;">
        
        @* HEADER *@
        <div style="margin-bottom: 2rem;">
            <h1 class="text-gradient glow-text" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">
                üìú ≈ûifre Ge√ßmi≈üi
            </h1>
            <p style="color: rgba(255,255,255,0.7); font-size: 1.125rem;">
                Kaydedilmi≈ü ≈üifrelerinizi y√∂netin, arayƒ±n ve filtreleyin
            </p>
        </div>

        @* STATISTICS *@
        @if (statistics != null)
        {
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: rgba(168,85,247,0.1); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(168,85,247,0.2);">
                    <div style="font-size: 2rem; font-weight: 700; color: #a855f7;">@statistics.TotalPasswords</div>
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">Toplam ≈ûifre</div>
                </div>
                <div style="background: rgba(236,72,153,0.1); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(236,72,153,0.2);">
                    <div style="font-size: 2rem; font-weight: 700; color: #ec4899;">@statistics.FavoriteCount</div>
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">Favoriler</div>
                </div>
                <div style="background: rgba(59,130,246,0.1); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(59,130,246,0.2);">
                    <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;">@statistics.TotalCopyCount</div>
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">Toplam Kopyalama</div>
                </div>
                <div style="background: rgba(16,185,129,0.1); padding: 1.5rem; border-radius: 16px; border: 1px solid rgba(16,185,129,0.2);">
                    <div style="font-size: 2rem; font-weight: 700; color: #10b981;">@FormatBytes(statistics.StorageSizeBytes)</div>
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">Depolama</div>
                </div>
            </div>
        }

        @* SEARCH & FILTERS *@
        <div style="margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" 
                       class="input" 
                       placeholder="üîç Ara (etiket, label, ≈üifre)..." 
                       @bind="searchQuery"
                       @bind:event="oninput"
                       @bind:after="ApplyFilters"
                       style="flex: 1;" />
                
                <select class="input" value="@selectedStrengthFilter" @onchange="OnStrengthFilterChanged" style="width: 200px;">
                    <option value="">T√ºm G√º√ßler</option>
                    <option value="VeryWeak">√áok Zayƒ±f</option>
                    <option value="Weak">Zayƒ±f</option>
                    <option value="Moderate">Orta</option>
                    <option value="Strong">G√º√ßl√º</option>
                    <option value="VeryStrong">√áok G√º√ßl√º</option>
                </select>

                <button class="btn btn-secondary" @onclick="ToggleViewMode" style="width: 150px;">
                    @(viewMode == ViewMode.Grid ? "üìã Liste" : "üé® Grid")
                </button>
            </div>

            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn @(showFavoritesOnly ? "btn-primary" : "btn-secondary")" 
                        @onclick="ToggleFavoritesFilter"
                        style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                    ‚≠ê @(showFavoritesOnly ? "T√ºm ≈ûifreler" : "Sadece Favoriler")
                </button>
                
                @if (filteredPasswords.Count > 0)
                {
                    <button class="btn btn-secondary" 
                            @onclick="ClearAllPasswords"
                            style="padding: 0.5rem 1rem; font-size: 0.875rem; background: rgba(239,68,68,0.1) !important; border-color: rgba(239,68,68,0.3) !important;">
                        üóëÔ∏è T√ºm√ºn√º Sil
                    </button>
                }
            </div>
        </div>

        @* LOADING *@
        @if (isLoading)
        {
            <div style="text-align: center; padding: 4rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                <div style="color: rgba(255,255,255,0.7);">Y√ºkleniyor...</div>
            </div>
        }
        @* EMPTY STATE *@
        else if (filteredPasswords.Count == 0)
        {
            <div style="text-align: center; padding: 4rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">üì≠</div>
                <h3 style="color: rgba(255,255,255,0.9); margin-bottom: 0.5rem;">Hen√ºz kayƒ±tlƒ± ≈üifre yok</h3>
                <p style="color: rgba(255,255,255,0.6);">Ana sayfadan ≈üifre olu≈üturup kaydedin</p>
                <a href="/" class="btn btn-primary" style="margin-top: 1.5rem; display: inline-block;">
                    ‚ú® ≈ûifre Olu≈ütur
                </a>
            </div>
        }
        @* PASSWORD LIST *@
        else
        {
            <div style="@(viewMode == ViewMode.Grid ? "display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;" : "display: flex; flex-direction: column; gap: 1rem;")">
                @foreach (var password in filteredPasswords)
                {
                    <div class="password-card" style="background: rgba(15,10,30,0.4); border: 1px solid rgba(168,85,247,0.2); border-radius: 16px; padding: 1.5rem; transition: all 0.3s;">
                        @* HEADER *@
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                @if (!string.IsNullOrEmpty(password.Label))
                                {
                                    <h4 style="color: #fff; font-size: 1.125rem; margin-bottom: 0.25rem;">@password.Label</h4>
                                }
                                <div style="color: rgba(255,255,255,0.5); font-size: 0.75rem;">
                                    @password.CreatedAt.ToLocalTime().ToString("dd MMM yyyy, HH:mm")
                                </div>
                            </div>
                            <button @onclick="() => ToggleFavorite(password.Id)" 
                                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.25rem;">
                                @(password.IsFavorite ? "‚≠ê" : "‚òÜ")
                            </button>
                        </div>

                        @* PASSWORD *@
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; font-family: 'JetBrains Mono', monospace; word-break: break-all;">
                            <div style="color: #a855f7; font-size: 1.125rem; font-weight: 600;">
                                @(showPasswordId == password.Id ? password.Password : new string('‚Ä¢', password.Length))
                            </div>
                        </div>

                        @* STRENGTH *@
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.875rem; color: rgba(255,255,255,0.7);">G√º√ß:</span>
                                <span style="font-weight: 600; color: @GetStrengthColor(password.StrengthLevel);">
                                    @GetStrengthText(password.StrengthLevel)
                                </span>
                            </div>
                            <div style="height: 6px; background: rgba(0,0,0,0.3); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: @GetStrengthColor(password.StrengthLevel); width: @GetStrengthPercentage(password.StrengthLevel)%; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        @* TAGS *@
                        @if (password.Tags.Any())
                        {
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                @foreach (var tag in password.Tags)
                                {
                                    <span style="background: rgba(168,85,247,0.2); color: #a855f7; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">
                                        #@tag
                                    </span>
                                }
                            </div>
                        }

                        @* STATS *@
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; font-size: 0.75rem; color: rgba(255,255,255,0.6);">
                            <div>üìè @password.Length kar.</div>
                            <div>üìä @password.Entropy.ToString("F1") bit</div>
                            <div>üìã @password.CopyCount kez</div>
                        </div>

                        @* ACTIONS *@
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" 
                                    @onclick="() => CopyPassword(password)"
                                    style="flex: 1; padding: 0.625rem; font-size: 0.875rem;">
                                üìã Kopyala
                            </button>
                            <button class="btn btn-secondary" 
                                    @onclick="() => TogglePasswordVisibility(password.Id)"
                                    style="padding: 0.625rem 1rem; font-size: 0.875rem;">
                                @(showPasswordId == password.Id ? "üëÅÔ∏è" : "üëÅÔ∏è‚Äçüó®Ô∏è")
                            </button>
                            <button class="btn btn-secondary" 
                                    @onclick="() => DeletePassword(password.Id)"
                                    style="padding: 0.625rem 1rem; font-size: 0.875rem; background: rgba(239,68,68,0.1) !important; border-color: rgba(239,68,68,0.3) !important;">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                }
            </div>
        }

        @* MESSAGE *@
        @if (!string.IsNullOrEmpty(message))
        {
            <div style="margin-top: 1.5rem; padding: 1rem; background: @(isError ? "rgba(239,68,68,0.1)" : "rgba(16,185,129,0.1)"); border: 1px solid @(isError ? "rgba(239,68,68,0.3)" : "rgba(16,185,129,0.3)"); border-radius: 12px; color: @(isError ? "#ef4444" : "#10b981");">
                @message
            </div>
        }
    </div>
</div>

@code {
    private List<PasswordHistory> allPasswords = new();
    private List<PasswordHistory> filteredPasswords = new();
    private PasswordHistoryStatistics? statistics;
    
    private string searchQuery = string.Empty;
    private string selectedStrengthFilter = string.Empty;
    private bool showFavoritesOnly = false;
    private ViewMode viewMode = ViewMode.Grid;
    private Guid? showPasswordId = null;
    
    private bool isLoading = true;
    private string message = string.Empty;
    private bool isError = false;

    private enum ViewMode { Grid, List }

    protected override async Task OnInitializedAsync()
    {
        await LoadPasswords();
    }

    private async Task LoadPasswords()
    {
        isLoading = true;
        try
        {
            allPasswords = await HistoryService.GetAllPasswordsAsync();
            statistics = await HistoryService.GetStatisticsAsync();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            ShowMessage($"Hata: {ex.Message}", true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        filteredPasswords = allPasswords;

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            var query = searchQuery.ToLowerInvariant();
            filteredPasswords = filteredPasswords.Where(p =>
                (p.Label?.ToLowerInvariant().Contains(query) ?? false) ||
                p.Tags.Any(t => t.ToLowerInvariant().Contains(query)) ||
                p.Password.Contains(searchQuery)
            ).ToList();
        }

        // Strength filter
        if (!string.IsNullOrEmpty(selectedStrengthFilter) && Enum.TryParse<PasswordStrengthLevel>(selectedStrengthFilter, out var level))
        {
            filteredPasswords = filteredPasswords.Where(p => p.StrengthLevel == level).ToList();
        }

        // Favorites filter
        if (showFavoritesOnly)
        {
            filteredPasswords = filteredPasswords.Where(p => p.IsFavorite).ToList();
        }

        // Sort by date (newest first)
        filteredPasswords = filteredPasswords.OrderByDescending(p => p.CreatedAt).ToList();
    }

    private void OnStrengthFilterChanged(ChangeEventArgs e)
    {
        selectedStrengthFilter = e.Value?.ToString() ?? string.Empty;
        ApplyFilters();
    }

    private void ToggleFavoritesFilter()
    {
        showFavoritesOnly = !showFavoritesOnly;
        ApplyFilters();
    }

    private void ToggleViewMode()
    {
        viewMode = viewMode == ViewMode.Grid ? ViewMode.List : ViewMode.Grid;
    }

    private void TogglePasswordVisibility(Guid id)
    {
        showPasswordId = showPasswordId == id ? null : id;
    }

    private async Task ToggleFavorite(Guid id)
    {
        var success = await HistoryService.ToggleFavoriteAsync(id);
        if (success)
        {
            await LoadPasswords();
            ShowMessage("Favori durumu g√ºncellendi", false);
        }
    }

    private async Task CopyPassword(PasswordHistory password)
    {
        try
        {
            await ClipboardService.CopyWithAutoClearAsync(password.Password, 30);
            await HistoryService.RecordAccessAsync(password.Id);
            await LoadPasswords();
            ShowMessage("‚úÖ ≈ûifre kopyalandƒ±! 30 saniye sonra otomatik temizlenecek.", false);
        }
        catch (Exception ex)
        {
            ShowMessage($"Kopyalama hatasƒ±: {ex.Message}", true);
        }
    }

    private async Task DeletePassword(Guid id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Bu ≈üifreyi silmek istediƒüinizden emin misiniz?"))
        {
            var success = await HistoryService.DeletePasswordAsync(id);
            if (success)
            {
                await LoadPasswords();
                ShowMessage("≈ûifre silindi", false);
            }
        }
    }

    private async Task ClearAllPasswords()
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "T√úM ≈üifreleri silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz!"))
        {
            var success = await HistoryService.DeleteAllPasswordsAsync();
            if (success)
            {
                await LoadPasswords();
                ShowMessage("T√ºm ≈üifreler silindi", false);
            }
        }
    }

    private void ShowMessage(string msg, bool error)
    {
        message = msg;
        isError = error;
        StateHasChanged();
        
        Task.Delay(3000).ContinueWith(_ =>
        {
            message = string.Empty;
            InvokeAsync(StateHasChanged);
        });
    }

    private string GetStrengthColor(PasswordStrengthLevel level) => level switch
    {
        PasswordStrengthLevel.VeryWeak => "#ef4444",
        PasswordStrengthLevel.Weak => "#f97316",
        PasswordStrengthLevel.Moderate => "#eab308",
        PasswordStrengthLevel.Strong => "#22c55e",
        PasswordStrengthLevel.VeryStrong => "#10b981",
        _ => "#6b7280"
    };

    private string GetStrengthText(PasswordStrengthLevel level) => level switch
    {
        PasswordStrengthLevel.VeryWeak => "√áok Zayƒ±f",
        PasswordStrengthLevel.Weak => "Zayƒ±f",
        PasswordStrengthLevel.Moderate => "Orta",
        PasswordStrengthLevel.Strong => "G√º√ßl√º",
        PasswordStrengthLevel.VeryStrong => "√áok G√º√ßl√º",
        _ => "Bilinmiyor"
    };

    private int GetStrengthPercentage(PasswordStrengthLevel level) => level switch
    {
        PasswordStrengthLevel.VeryWeak => 20,
        PasswordStrengthLevel.Weak => 40,
        PasswordStrengthLevel.Moderate => 60,
        PasswordStrengthLevel.Strong => 80,
        PasswordStrengthLevel.VeryStrong => 100,
        _ => 0
    };

    private string FormatBytes(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }
}
